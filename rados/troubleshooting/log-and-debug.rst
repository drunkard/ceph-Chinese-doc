================
 日志记录和调试
================
.. Logging and Debugging

你应该在运行时增加调试选项来调试问题；
也可以把调试选项添加到 Ceph 配置文件里来调试启动问题，
然后查看 ``/var/log/ceph`` （默认位置）下的日志文件。

.. tip:: 调试输出会拖慢系统，
   这种延时有可能掩盖竞争条件。

日志记录是资源密集型任务。如果你碰到的问题在集群的某个特定区域，
只启用那个区域对应的日志功能即可。例如，
你的 OSD 运行良好、元数据服务器却不行，
这时应该先打开那个可疑元数据服务器例程的调试日志；
如果不行再打开各子系统的日志。

.. important:: 详尽的日志每小时可能超过 1GB ，如果你的系统盘满了，
   这个节点就会停止工作。

如果你要打开或增加 Ceph 日志级别，确保系统盘空间足够。
滚动日志文件的方法见\ `加快日志滚动`_\ 。
集群稳定运行后，可以关闭不必要的调试选项以更好地运行。
在运营中记录调试输出会拖慢系统、且浪费资源。

可用选项参见\ `子系统、日志和调试选项`_\ 。


运行时
======
.. Runtime

如果你想查看一进程的运行时配置，必须先登录对应主机，
然后执行命令：

.. prompt:: bash $

   ceph daemon {daemon-name} config show | less

例如：

.. prompt:: bash $

   ceph daemon osd.0 config show | less

要在运行时激活 Ceph 的调试输出（即 ``dout()`` ），用
``ceph tell`` 命令把参数注入运行时配置：

.. prompt:: bash $

   ceph tell {daemon-type}.{daemon id or *} config set {name} {value}

用 ``osd`` 、 ``mon`` 或 ``mds`` 替代 ``{daemon-type}`` 。
你可以用星号（ ``*`` ）把配置应用到同类型的所有守护进程，
或者指定具体守护进程的 ID 。例如，要给名为 ``ods.0`` 的
``ceph-osd`` 守护进程提高调试级别，用下列命令：

.. prompt:: bash $

   ceph tell osd.0 config set debug_osd 0/5

``ceph tell`` 命令会贯穿所有监视器。如果你不能绑定监视器，
还可以登录你要改的那台主机用 ``ceph daemon`` 来更改。
例如：

.. prompt:: bash $

   sudo ceph daemon osd.0 config set debug_osd 0/5

可用选项参见\ `子系统、日志和调试选项`_\ 。


启动时
======
.. Boot Time

要在启动时激活调试输出（\ *即* ``dout()`` ），
你得把选项加入配置文件。
各进程共有配置可写在配置文件的 ``[global]`` 下，
某类进程的配置可写在守护进程段下
（\ *比如* ``[mon]`` 、 ``[osd]`` 、 ``[mds]`` ）。例如：

.. code-block:: ini

    [global]
        debug ms = 1/5

    [mon]
        debug mon = 20
        debug paxos = 1/5
        debug auth = 2

    [osd]
        debug osd = 1/5
        debug filestore = 1/5
        debug journal = 1
        debug monc = 5/20

    [mds]
        debug mds = 1
        debug mds balancer = 1

可用选项参见\ `子系统、日志和调试选项`_\ 。


加快日志滚动
============
.. Accelerating Log Rotation

如果某一主机的日志文件系统快满了，
可以修改 ``/etc/logrotate.d/ceph`` 内的日志滚动配置以加快滚动。
要增加日志滚动频率（可以保证文件系统空间不会耗尽），
可以在 ``weekly`` 频率指令后加一个 ``size`` （尺寸）指令。
为使卷利用曲线平滑些，可以考虑把 ``weekly`` 改成 ``daily`` 、
把 ``rotate`` 改成 ``30`` 。增加 size 选项的过程如下：

#. 注意 ``/etc/logrotate.d/ceph`` 文件的默认配置： ::

      rotate 7
      weekly
      compress
      sharedscripts

#. 修改，增加一个 ``size`` 选项： ::

      rotate 7
      weekly
      size 500M
      compress
      sharedscripts

#. 打开 crontab 编辑器：

   .. prompt:: bash $

      crontab -e

#. 增加一个 crontab 条目，让 cron 去检查 ``/etc/logrorate.d/ceph`` 文件： ::

      30 * * * * /usr/sbin/logrotate /etc/logrotate.d/ceph >/dev/null 2>&1

本例中，每 30 分钟检查一次 ``/etc/logrorate.d/ceph`` 文件，并可能滚动一次。


Valgrind
========

你也许还得追踪内存和线程问题，
可以在 Valgrind 中运行一个守护进程、一类进程、或整个集群。
Valgrind 是计算密集型程序，应该只用于开发或调试，
否则会拖慢系统。其消息记录到 ``stderr`` 。


子系统、日志和调试选项
======================
.. Subsystem, Log and Debug Settings

大多数情况下你可以通过子系统打开调试。


Ceph 子系统概览
---------------
.. Ceph Subsystems

各子系统都有日志级别用于分别控制其输出日志（叫作日志级别， log level ）、
和暂存日志（叫做内存级别， memory level ）。
你可以分别为每个子系统设置这两个不同的记录级别。
Ceph 的日志级别从 ``1`` 到 ``20`` ，
``1`` 是简洁、 ``20`` 是详尽。在少数特殊情况下，
日志记录级别可以设置成大于 20 的数值，产生的日志也是极其详尽。

内存驻留日志不会发送到输出日志，
除非满足下面的一个或多个条件：：

- 致命信号冒出来了，或者
- 源码中的 ``assert`` 断言被触发，或者
- 手动要求把内存里的日志发送到输出日志。详情见
  `Ceph 管理工具文档里的一个例子，
  叙述了如何提交管理套接字命令
  <http://docs.ceph.com/en/latest/man/8/ceph/#daemon>`_ 。

日志级别和内存级别可以一起设置或分别设置。
如果给一个子系统分配了单个数值，那么日志级别和内存级别都会设置为这个级别。
比如， ``debug ms = 5`` 会把 ``ms`` 子系统的日志级别设置为 ``5`` 、
且内存级别也设置为 ``5`` 。反之，
如果给一个子系统分配了用斜杠（ / ）分隔的两个数值，
那么第一个数值决定日志级别、\
第二个决定内存级别。例如， ``debug ms = 1/5``
会把 ``ms`` 子系统的日志级别设为 ``1`` 、内存级别设为 ``5`` ，\
如下：

.. code-block:: ini

    debug {subsystem} = {log-level}/{memory-level}
    #for example
    debug mds balancer = 1/20


下表列出了 Ceph 子系统及其默认日志和内存级别。
一旦你完成调试，应该恢复默认值、
或一个适合日常运营的级别。

+--------------------------+-----------+--------------+
| 子系统                   | 日志级别  | 内存日志级别 |
+==========================+===========+==============+
| ``default``              |     0     |      5       |
+--------------------------+-----------+--------------+
| ``lockdep``              |     0     |      1       |
+--------------------------+-----------+--------------+
| ``context``              |     0     |      1       |
+--------------------------+-----------+--------------+
| ``crush``                |     1     |      1       |
+--------------------------+-----------+--------------+
| ``mds``                  |     1     |      5       |
+--------------------------+-----------+--------------+
| ``mds balancer``         |     1     |      5       |
+--------------------------+-----------+--------------+
| ``mds log``              |     1     |      5       |
+--------------------------+-----------+--------------+
| ``mds log expire``       |     1     |      5       |
+--------------------------+-----------+--------------+
| ``mds migrator``         |     1     |      5       |
+--------------------------+-----------+--------------+
| ``buffer``               |     0     |      1       |
+--------------------------+-----------+--------------+
| ``timer``                |     0     |      1       |
+--------------------------+-----------+--------------+
| ``filer``                |     0     |      1       |
+--------------------------+-----------+--------------+
| ``striper``              |     0     |      1       |
+--------------------------+-----------+--------------+
| ``objecter``             |     0     |      1       |
+--------------------------+-----------+--------------+
| ``rados``                |     0     |      5       |
+--------------------------+-----------+--------------+
| ``rbd``                  |     0     |      5       |
+--------------------------+-----------+--------------+
| ``rbd mirror``           |     0     |      5       |
+--------------------------+-----------+--------------+
| ``rbd replay``           |     0     |      5       |
+--------------------------+-----------+--------------+
| ``rbd pwl``              |     0     |      5       |
+--------------------------+-----------+--------------+
| ``journaler``            |     0     |      5       |
+--------------------------+-----------+--------------+
| ``objectcacher``         |     0     |      5       |
+--------------------------+-----------+--------------+
| ``immutable obj cache``  |     0     |      5       |
+--------------------------+-----------+--------------+
| ``client``               |     0     |      5       |
+--------------------------+-----------+--------------+
| ``osd``                  |     1     |      5       |
+--------------------------+-----------+--------------+
| ``optracker``            |     0     |      5       |
+--------------------------+-----------+--------------+
| ``objclass``             |     0     |      5       |
+--------------------------+-----------+--------------+
| ``filestore``            |     1     |      3       |
+--------------------------+-----------+--------------+
| ``journal``              |     1     |      3       |
+--------------------------+-----------+--------------+
| ``ms``                   |     0     |      5       |
+--------------------------+-----------+--------------+
| ``mon``                  |     1     |      5       |
+--------------------------+-----------+--------------+
| ``monc``                 |     0     |      10      |
+--------------------------+-----------+--------------+
| ``paxos``                |     1     |      5       |
+--------------------------+-----------+--------------+
| ``tp``                   |     0     |      5       |
+--------------------------+-----------+--------------+
| ``auth``                 |     1     |      5       |
+--------------------------+-----------+--------------+
| ``crypto``               |     1     |      5       |
+--------------------------+-----------+--------------+
| ``finisher``             |     1     |      1       |
+--------------------------+-----------+--------------+
| ``reserver``             |     1     |      1       |
+--------------------------+-----------+--------------+
| ``heartbeatmap``         |     1     |      5       |
+--------------------------+-----------+--------------+
| ``perfcounter``          |     1     |      5       |
+--------------------------+-----------+--------------+
| ``rgw``                  |     1     |      5       |
+--------------------------+-----------+--------------+
| ``rgw sync``             |     1     |      5       |
+--------------------------+-----------+--------------+
| ``rgw datacache``        |     1     |      5       |
+--------------------------+-----------+--------------+
| ``rgw access``           |     1     |      5       |
+--------------------------+-----------+--------------+
| ``rgw dbstore``          |     1     |      5       |
+--------------------------+-----------+--------------+
| ``rgw lifecycle``        |     1     |      5       |
+--------------------------+-----------+--------------+
| ``rgw notification``     |     1     |      5       |
+--------------------------+-----------+--------------+
| ``javaclient``           |     1     |      5       |
+--------------------------+-----------+--------------+
| ``asok``                 |     1     |      5       |
+--------------------------+-----------+--------------+
| ``throttle``             |     1     |      1       |
+--------------------------+-----------+--------------+
| ``refs``                 |     0     |      0       |
+--------------------------+-----------+--------------+
| ``compressor``           |     1     |      5       |
+--------------------------+-----------+--------------+
| ``bluestore``            |     1     |      5       |
+--------------------------+-----------+--------------+
| ``bluefs``               |     1     |      5       |
+--------------------------+-----------+--------------+
| ``bdev``                 |     1     |      3       |
+--------------------------+-----------+--------------+
| ``kstore``               |     1     |      5       |
+--------------------------+-----------+--------------+
| ``rocksdb``              |     4     |      5       |
+--------------------------+-----------+--------------+
| ``fuse``                 |     1     |      5       |
+--------------------------+-----------+--------------+
| ``mgr``                  |     2     |      5       |
+--------------------------+-----------+--------------+
| ``mgrc``                 |     1     |      5       |
+--------------------------+-----------+--------------+
| ``dpdk``                 |     1     |      5       |
+--------------------------+-----------+--------------+
| ``eventtrace``           |     1     |      5       |
+--------------------------+-----------+--------------+
| ``prioritycache``        |     1     |      5       |
+--------------------------+-----------+--------------+
| ``test``                 |     0     |      5       |
+--------------------------+-----------+--------------+
| ``cephfs mirror``        |     0     |      5       |
+--------------------------+-----------+--------------+
| ``cephsqlite``           |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore``             |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore onode``       |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore odata``       |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore ompap``       |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore tm``          |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore t``           |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore cleaner``     |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore epm``         |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore lba``         |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore fixedkv tree``|     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore cache``       |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore journal``     |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore device``      |     0     |      5       |
+--------------------------+-----------+--------------+
| ``seastore backref``     |     0     |      5       |
+--------------------------+-----------+--------------+
| ``alienstore``           |     0     |      5       |
+--------------------------+-----------+--------------+
| ``mclock``               |     1     |      5       |
+--------------------------+-----------+--------------+
| ``cyanstore``            |     0     |      5       |
+--------------------------+-----------+--------------+
| ``ceph exporter``        |     1     |      5       |
+--------------------------+-----------+--------------+
| ``memstore``             |     1     |      5       |
+--------------------------+-----------+--------------+
| ``trace``                |     1     |      5       |
+--------------------------+-----------+--------------+


日志记录和调试选项
------------------
.. Logging and Debugging Settings

在 Ceph 配置文件里没必要设置日志和调试选项，
但你可以按需覆盖默认值。 Ceph 支持如下配置：

.. confval:: log_file
.. confval:: log_max_new
.. confval:: log_max_recent
.. confval:: log_to_file
.. confval:: log_to_stderr
.. confval:: err_to_stderr
.. confval:: log_to_syslog
.. confval:: err_to_syslog
.. confval:: log_flush_on_exit
.. confval:: clog_to_monitors
.. confval:: clog_to_syslog
.. confval:: mon_cluster_log_to_syslog
.. confval:: mon_cluster_log_file


OSD
---

.. confval:: osd_debug_drop_ping_probability
.. confval:: osd_debug_drop_ping_duration


Filestore
---------

.. confval:: filestore_debug_omap_check


MDS
---

- :confval:`mds_debug_scatterstat`
- :confval:`mds_debug_frag`
- :confval:`mds_debug_auth_pins`
- :confval:`mds_debug_subtrees`


RADOS 网关
----------

- :confval:`rgw_log_nonexistent_bucket`
- :confval:`rgw_log_object_name`
- :confval:`rgw_log_object_name_utc`
- :confval:`rgw_enable_ops_log`
- :confval:`rgw_enable_usage_log`
- :confval:`rgw_usage_log_flush_threshold`
- :confval:`rgw_usage_log_tick_interval`
